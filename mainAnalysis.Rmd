---
title: "mainAnalysis"
output: html_document
date: '2022-11-09'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(gt)

gitDir <- "~/Documents/giterdone/ncaaShots/"
dataDir <- paste0(gitDir,"data/")
figDir <- paste0(gitDir,"figures/")

setwd(gitDir)
source(paste0(gitDir,"gzShots.R"))

shotDB <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
playerDB <- readRDS(paste0(gitDir,"playerDatabase.RDS"))
```

Fixes
-2497996 has NA in h1 (check for others, drop them, maybe purge at input)

-h NA 2497996 2476165 2475011 2489570 2498323 2499930
-a NA 2476165 2482591 2498387 2475485 2475015 2475018 2498550 2504983 2475011 2482546 2489584

-2496295 has "goal" as a shot outcome

-2475546 broke loop, 20221203 is borked
-- 20221204 also borked 2502026 

20221217 errors
-- 2498120, 2492289
head: illegal line count -- -1
head: illegal line count -- -1
Error in read.table(file = file, header = header, sep = sep, quote = quote,  : 



To-Do
-logos, twitter handles, conferences, in a master dataframe
-plot of shot value v. shots taken
    -do this by running the current code and storing all the data, just add a "top scorer" flag
-shot chart fxn (ngames, ndates, % by quad)
-find best defenders (impact on/off)
-best overall on/off (defensive and offensive on/off)
-good shooters good shots (after logos)



-read in all 2021-22 data
-get team logos into a dataframe




```{r run daily}
gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))

lastDate <- as.Date(tail(gameDB$date, n = 1),  "%b %d %Y")
today <- Sys.Date()

#days finished but not in DB
needDates <- (lastDate + 1):(as.Date(today) - 1)
needDates <- format(as.Date(needDates, origin = .Date(0)), "%Y%m%d")

#remove today
needDates <- needDates[which(needDates != format(as.Date(today), "%Y%m%d"))]

for (gameDate in needDates) {
  date()
  print(gameDate)
  
  getGames <- paste0("sh getGames.sh ",gameDate)
  system(getGames)
  
  gameList <- read.table("tmpFiles/gameList.txt")
  
  for (g in gameList$V1) {
    
    if (! g %in% readRDS(paste0(gitDir,"gameDatabase.RDS"))$gameNum ) {
      shotDB <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
      gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
      playerDB <- readRDS(paste0(gitDir,"playerDatabase.RDS"))
      
      gzShots(gameNum = g,
              shotDB = shotDB,
              playerDB = playerDB,
              gameDB = gameDB)
    }
  }
}
shotDF <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
gameDF <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
playerDF <- readRDS(paste0(gitDir,"playerDatabase.RDS"))

rm(shotDB); rm(playerDB); rm(gameDB)
```


```{r check shots}
ggplot(data = shotDF,
       aes(x = baseline,
           y = depth,
           col = shotQuadrant)) +
  geom_point(alpha = .15, size = 3.25, shape = 15)

#home/away 3pt imbalance
table(subset(shotDF, FGtype == 3)$shotQuadrant)

table(subset(shotDF, FGtype == 3 & team.x == "home")$shotQuadrant)

table(subset(shotDF, FGtype == 3 & team.x == "away")$shotQuadrant)

ggplot() + 
  geom_histogram(aes(x = subset(shotDF, FGtype == 3 & depth > 15)$calcDist), 
                 binwidth = 1)

mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist < 22)$outcome == "make")
mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 22 & calcDist <= 24)$outcome == "make")
mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 24 & calcDist <= 26)$outcome == "make")
mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 26 & calcDist <= 28)$outcome == "make")
mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 28 & calcDist <= 30)$outcome == "make")
mean(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 30)$outcome == "make")

length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist < 22)$outcome == "make")
length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 22 & calcDist <= 24)$outcome == "make")
length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 24 & calcDist <= 26)$outcome == "make")
length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 26 & calcDist <= 28)$outcome == "make")
length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 28 & calcDist <= 30)$outcome == "make")
length(subset(shotDF, FGtype == 3 & depth > 15 & calcDist > 30)$outcome == "make")
```

quadrant percents
```{r add expected value}

#percent by clock
mean(subset(shotDF, shotClock <= 10)$outcome == "make")
mean(subset(shotDF, shotClock > 10 & shotClock < 20)$outcome == "make")
mean(subset(shotDF, shotClock >= 20)$outcome == "make")

allSQ <- unique(shotDF$shotQuadrant)

quadFGPer <- data.frame(allSQ)
quadFGPer$all <- 0
quadFGPer$early <- 0
quadFGPer$mid <- 0
quadFGPer$late <- 0

for (sq in allSQ) {
  sqRow <- which(quadFGPer$allSQ == sq)
  
  quadFGPer$all[sqRow] <- 100 * mean(subset(shotDF, shotQuadrant == sq)$outcome == "make")
  quadFGPer$early[sqRow] <- 100 * mean(subset(shotDF, shotQuadrant == sq & shotClock > 20)$outcome == "make")
  quadFGPer$mid[sqRow] <- 100 * mean(subset(shotDF, shotQuadrant == sq & shotClock <= 20 & shotClock >= 10)$outcome == "make")
  quadFGPer$late[sqRow] <- 100 * mean(subset(shotDF, shotQuadrant == sq & shotClock < 10)$outcome == "make")
}

quadFGPer <- quadFGPer[order(quadFGPer$allSQ),]
quadFGPer <- quadFGPer[c(9,7,6,8,2,3,1,5,4,11,12,10,14,13),]

shotDF$expFGPer <- 0

#add expected FG% by shot quadrant and time to each shot
sq <- "AtRim"
for (sq in allSQ) {
  sqRow <- which(quadFGPer$allSQ == sq)
  shotDF$expFGPer[which(shotDF$shotQuadrant == sq & shotDF$shotClock < 10)] <- quadFGPer$late[sqRow] / 100
  shotDF$expFGPer[which(shotDF$shotQuadrant == sq & shotDF$shotClock <= 20 & shotDF$shotClock >= 10)] <- quadFGPer$mid[sqRow] / 100
  shotDF$expFGPer[which(shotDF$shotQuadrant == sq & shotDF$shotClock > 20)] <- quadFGPer$early[sqRow] / 100
}

#add expected points to each shot attempt
shotDF$expPts <- shotDF$FGtype * shotDF$expFGPer
shotDF$actPts <- shotDF$points - shotDF$expPts

#allBxD <- unique(paste0(shotDF$baseline,"_",shotDF$depth))
```

Table of Points Generated for a Team
```{r}
focalTeam <- "North Carolina"

subset(playerDF, team == focalTeam)

for (focalPlayer in subset(playerDF, team == focalTeam)$playerID) {
  focalName <- subset(playerDF, playerID == focalPlayer)$playerName
  #number of shots
  nShots  <- dim(subset(shotDF, playerID == focalPlayer))[1]
  if (nShots > 10) {
    #points v exp
    expPts <- sum(subset(shotDF, playerID == focalPlayer)$expPts) / nShots
    ptsOverExp <- sum(subset(shotDF, playerID == focalPlayer)$actPts)
    totPts <- expPts + (ptsOverExp / nShots)
    
    print(paste0(focalName," | ",nShots," shots | ",
                 round(ptsOverExp, digits = 1)," pts | ",
                 round(totPts, digits = 2)," pts/shot v. ",round(expPts, digits = 2)," expected"))
  }
}

#mando
focalPlayer <- 1185948
#nance
focalPlayer <- 1133861

focalName <- subset(playerDF, playerID == focalPlayer)$playerName
#number of shots


for (g in unique(subset(shotDF, playerID == focalPlayer)$gameNum)) {
  #points v exp
  oppName <- subset(shotDF, playerID == focalPlayer & gameNum == g)$oppAbbv[1]
  nShots  <- dim(subset(shotDF, playerID == focalPlayer & gameNum == g))[1]
  expPts <- sum(subset(shotDF, playerID == focalPlayer & gameNum == g)$expPts) / nShots
  ptsOverExp <- sum(subset(shotDF, playerID == focalPlayer & gameNum == g)$actPts)
  totPts <- expPts + (ptsOverExp / nShots)
  
  print(paste0(oppName," | ",nShots," shots | ",
               round(ptsOverExp, digits = 1)," pts | ",
               round(totPts, digits = 2)," pts/shot v. ",round(expPts, digits = 2)," expected"))
}

```

Top Point Generated in NCAA
```{r}

tsPlayer <- vector()
tsTeam <- vector()
tsnShots <- vector()
tsnGames <- vector()
tsspg <- vector()
tsptsAdded <- vector()
tsptsPerShot <-  vector()

ggplot() +
  geom_histogram(aes(table(shotDF$playerID)), bins = 50)

#set shot min to top 20% of DB
shotMin <- quantile(table(shotDF$playerID), probs = c(.8))
gameMin <- quantile(table(c(gameDF$home,gameDF$away)))[3]
ptsPerShot <- .1
shotsPerGame <- 9

playerList <- names(table(shotDF$playerID)[table(shotDF$playerID) >= shotMin])

focalPlayer <- playerList[14]

for (focalPlayer in playerList) {
  focalName <- subset(playerDF, playerID == focalPlayer)$playerName
  playerTeam <- subset(playerDF, playerID == focalPlayer)$team[1]
  #number of games
  nGames <- length(unique(subset(shotDF, playerID == focalPlayer)$gameNum))
  #number of shots
  nShots  <- dim(subset(shotDF, playerID == focalPlayer))[1]
  #points v exp
  ptsOverExp <- sum(subset(shotDF, playerID == focalPlayer)$actPts)
  
  if ( ptsOverExp / nShots > ptsPerShot & nShots / nGames >= shotsPerGame & nGames > gameMin) {
    tsPlayer <- c(tsPlayer,focalName)
    tsTeam <- c(tsTeam,playerTeam)
    tsnShots <- c(tsnShots,nShots)
    tsnGames <- c(tsnGames,nGames)
    tsspg <- c(tsspg,nShots / nGames)
    tsptsAdded <- c(tsptsAdded,ptsOverExp)
    tsptsPerShot <- c(tsptsPerShot,ptsOverExp / nShots)

    print(paste0(focalName," | ",playerTeam," | ",
                 nShots," shots, ",round(nShots/nGames, digits = 1)," per game | ",
                 round(ptsOverExp, digits = 1)," pts | +",
                 round(ptsOverExp/nShots, digits = 2)," per shot"))
  }
}

topScorers <- cbind.data.frame(tsPlayer,tsTeam,tsnShots,tsnGames,tsspg,tsptsAdded,tsptsPerShot)
colnames(topScorers) <- c("Player","Team","Shots","Games","Shots/Game","Pts Added","Pts/Shot")

topScorers <- topScorers[order(topScorers$`Pts/Shot`, decreasing = T),]

#sort and show top-10
topScorers <- head(topScorers, n = 10)
topScorers$`Shots/Game` <- round(topScorers$`Shots/Game`, digits = 1)
topScorers$`Pts Added` <- round(topScorers$`Pts Added`, digits = 1)
topScorers$`Pts/Shot` <- round(topScorers$`Pts/Shot`, digits = 3)

### make a table
gt_tbl <- gt(topScorers[,!colnames(topScorers) %in% "Shots"])

gt_tbl <-
  gt_tbl %>%
    tab_header(
      title = md("**NCAA Top-10: Points Added Per Shot**"),
      subtitle = paste0("Min Shots Charted = ",shotMin,"   |   Points Added Over NCAA Average")
      )

gt_tbl <- 
  gt_tbl %>%
  tab_source_note(
    source_note = md(paste0("_Average value calc. from location and shot clock status of ",dim(shotDF)[1]," shots in the 2022-23 season_"))
  )

# Show the gt Table
gt_tbl <- 
  gt_tbl %>%
  data_color(
    columns = `Pts/Shot`,
    colors = scales::col_numeric(
      palette = c("white", "#C5050C"),
      domain = c(0, 1.66)
    )
  )

gt_tbl <- 
  gt_tbl %>%
  data_color(
    columns = `Shots/Game`,
    colors = scales::col_numeric(
      palette = c("white", "#4B9CD3"),
      domain = c(5, 15)
    )
  )

gt_tbl <- 
  gt_tbl %>%
  cols_align(
    align = "center",
    columns = c(Games,`Shots/Game`,`Pts Added`,`Pts/Shot`)
  )

gt_tbl <- 
  gt_tbl %>%
  tab_options(heading.title.font.size = 30, column_labels.font.weight = 'bold')


gt_tbl %>% gtsave(paste0(figDir,"TopTen_PtsPerShot_min",shotMin,"shots.html"))

gt_tbl
```


defensive impact
```{r}
p <- 1232015

minShots <- 50
minCourtTime <- .2

for (p in playerDF$playerID) {
  playerName <- subset(playerDF, playerID == p)$playerName
  teamAbbv <- subset(playerDF, playerID == p)$teamAbbv
  
  ### THIS ONLY CHECKS FOR HOME TEAM... WHOOPS - FIRST DROP shotDF by TEAM/OPP then any player as below:
  
  #shots against Seth
  plyrIn <- shotDF$h1 == p | shotDF$h2 == p | shotDF$h3 == p | shotDF$h4 == p | shotDF$h5 == p
  
  plyrShots <- shotDF[plyrIn,]
  nplyrShots <- shotDF[!plyrIn,]
  
  nplyrShots <- nplyrShots[which(nplyrShots$oppAbbv == teamAbbv),]
  plyrShots <- plyrShots[which(plyrShots$oppAbbv == teamAbbv),]

  #needs to be on-off for 25/75%
  percentTeamShots <- dim(plyrShots)[1] / (dim(plyrShots)[1] + dim(nplyrShots)[1])
  
  if ( percentTeamShots > minCourtTime & (1 - percentTeamShots) < (1 - minCourtTime) ) {
    
    
    offCourt <- 1 - mean(nplyrShots$outcome == "miss")
    offCourtPts <- sum(nplyrShots$actPts) / dim(nplyrShots)[1]
    onCourt <- 1 - mean(plyrShots$outcome == "miss")
    onCourtPts <- sum(plyrShots$actPts) / dim(plyrShots)[1]
    benchDiff <- 100 * (offCourt - onCourt)
    benchDiffPts <- offCourtPts - onCourtPts
  
    
    if ( benchDiff > 20) {
      print(paste0(playerName," | ",round(benchDiffPts, digits = 3)," | ",round(benchDiff, digits = 1)," | ",
                   dim(plyrShots)[1],"/",dim(nplyrShots)[1]," | ",teamAbbv))
    }
  }
}

ggplot(data = plyrShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)

ggplot(data = nplyrShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)


```

UNC defense
```{r}

playerList <- subset(playerDF, teamAbbv == "UNC")$playerID

p <- playerList[3]

for (p in playerList) {
  playerName <- subset(playerDF, playerID == p)$playerName
  teamAbbv <- subset(playerDF, playerID == p)$teamAbbv
  
  ### THIS ONLY CHECKS FOR HOME TEAM... WHOOPS - FIRST DROP shotDF by TEAM/OPP then any player as below:
  
  #shots against Seth
  plyrIn <- shotDF$h1 == p | shotDF$h2 == p | shotDF$h3 == p | shotDF$h4 == p | shotDF$h5 == p | shotDF$a1 == p | shotDF$a2 == p | shotDF$a3 == p | shotDF$a4 == p | shotDF$a5 == p
  
  plyrShots <- shotDF[plyrIn,]
  nplyrShots <- shotDF[!plyrIn,]
  
  nplyrShots <- nplyrShots[which(nplyrShots$oppAbbv == teamAbbv),]
  plyrShots <- plyrShots[which(plyrShots$oppAbbv == teamAbbv),]

  #needs to be on-off for 25/75%
  percentTeamShots <- dim(plyrShots)[1] / (dim(plyrShots)[1] + dim(nplyrShots)[1])
  
    
    
  offCourt <- 1 - mean(nplyrShots$outcome == "miss")
  offCourtPts <- sum(nplyrShots$actPts) / dim(nplyrShots)[1]
  onCourt <- 1 - mean(plyrShots$outcome == "miss")
  onCourtPts <- sum(plyrShots$actPts) / dim(plyrShots)[1]
  benchDiff <- 100 * (offCourt - onCourt)
  benchDiffPts <- offCourtPts - onCourtPts
  
  #rim, close, 3pt difference
  rimDiff <- round(100 * (mean(subset(plyrShots, shotQuadrant == "AtRim")$points != 0) - mean(subset(nplyrShots, shotQuadrant == "AtRim")$points != 0)), digits = 1)
  
  closeDiff <- round(100 * (mean(subset(plyrShots, shotLoc %in% c("0-5ft","5-10ft"))$points != 0) - mean(subset(nplyrShots, shotLoc %in% c("0-5ft","5-10ft"))$points != 0)), digits = 1)
  
  threeDiff <- round(100 * (mean(subset(plyrShots, shotLoc == "Three")$points != 0) - mean(subset(nplyrShots, shotLoc == "Three")$points != 0)), digits = 1)

  
  print(paste0(playerName," | ",round(benchDiffPts, digits = 3)," | ",round(benchDiff, digits = 1)," | ",
               dim(plyrShots)[1],"/",dim(nplyrShots)[1]," | ",rimDiff,"/",closeDiff,"/",threeDiff))
}

ggplot(data = plyrShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)

ggplot(data = nplyrShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)

```

```{r UNC stuff}

focalPlayer <- 1243718
focalPlayer <- 1243722

plotShots <- subset(shotDF, playerID == focalPlayer)

ggplot(data = plotShots,
       aes(x = baseline,
           y = depth,
           col = shotQuadrant, 
           shape = outcome)) +
  geom_jitter(alpha = .75,size = 3) + 
  xlim(c(0,50)) + ylim(c(0,40))

```

