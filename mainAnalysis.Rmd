---
title: "mainAnalysis"
output: html_document
date: '2022-11-09'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(gt)

gitDir <- "~/Documents/giterdone/ncaaShots/"
dataDir <- paste0(gitDir,"data/")

setwd(gitDir)
source(paste0(gitDir,"gzShots.R"))

shotDB <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
playerDB <- readRDS(paste0(gitDir,"playerDatabase.RDS"))
```

To-Do
-table of top shot value players
-plot of shot value v. shots taken
-shot chart fxn (ngames, ndates, % by quad)
-find best defenders (impact on/off)
-best overall on/off (defensive and offensive on/off)
-good shooters good shots (after logos)


-read in all 2021-22 data
-get team logos into a dataframe




```{r run daily}
gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))

lastDate <- as.Date(tail(gameDB$date, n = 1),  "%b %d %Y")
today <- Sys.Date()

#days finished but not in DB
needDates <- (lastDate + 1):(as.Date(today) - 1)
needDates <- format(as.Date(needDates, origin = .Date(0)), "%Y%m%d")

#remove today
needDates <- needDates[which(needDates != format(as.Date(today), "%Y%m%d"))]

for (gameDate in needDates) {
  date()
  print(gameDate)
  
  getGames <- paste0("sh getGames.sh ",gameDate)
  system(getGames)
  
  gameList <- read.table("tmpFiles/gameList.txt")
  
  for (g in gameList$V1) {
    
    if (! g %in% readRDS(paste0(gitDir,"gameDatabase.RDS"))$gameNum ) {
      shotDB <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
      gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
      playerDB <- readRDS(paste0(gitDir,"playerDatabase.RDS"))
      
      gzShots(gameNum = g,
              shotDB = shotDB,
              playerDB = playerDB,
              gameDB = gameDB)
    }
  }
}
```


```{r check shots}
shotDB <- readRDS(paste0(gitDir,"shotDatabase.RDS"))
gameDB <- readRDS(paste0(gitDir,"gameDatabase.RDS"))
playerDB <- readRDS(paste0(gitDir,"playerDatabase.RDS"))

ggplot(data = shotDB,
       aes(x = baseline,
           y = depth,
           col = shotQuadrant)) +
  geom_point(alpha = .15, size = 3.25, shape = 15)

```

quadrant percents
```{r add expected value}

#percent by clock
mean(subset(shotDB, shotClock <= 10)$outcome == "make")
mean(subset(shotDB, shotClock > 10 & shotClock < 20)$outcome == "make")
mean(subset(shotDB, shotClock >= 20)$outcome == "make")

allSQ <- unique(shotDB$shotQuadrant)

quadFGPer <- data.frame(allSQ)
quadFGPer$all <- 0
quadFGPer$early <- 0
quadFGPer$mid <- 0
quadFGPer$late <- 0

for (sq in allSQ) {
  sqRow <- which(quadFGPer$allSQ == sq)
  
  quadFGPer$all[sqRow] <- 100 * mean(subset(shotDB, shotQuadrant == sq)$outcome == "make")
  quadFGPer$early[sqRow] <- 100 * mean(subset(shotDB, shotQuadrant == sq & shotClock > 20)$outcome == "make")
  quadFGPer$mid[sqRow] <- 100 * mean(subset(shotDB, shotQuadrant == sq & shotClock <= 20 & shotClock >= 10)$outcome == "make")
  quadFGPer$late[sqRow] <- 100 * mean(subset(shotDB, shotQuadrant == sq & shotClock < 10)$outcome == "make")
}

quadFGPer <- quadFGPer[order(quadFGPer$allSQ),]
quadFGPer <- quadFGPer[c(9,7,6,8,2,3,1,5,4,11,12,10,14,13),]

shotDB$expFGPer <- 0

#add expected FG% by shot quadrant and time to each shot
sq <- "AtRim"
for (sq in allSQ) {
  sqRow <- which(quadFGPer$allSQ == sq)
  shotDB$expFGPer[which(shotDB$shotQuadrant == sq & shotDB$shotClock < 10)] <- quadFGPer$late[sqRow] / 100
  shotDB$expFGPer[which(shotDB$shotQuadrant == sq & shotDB$shotClock <= 20 & shotDB$shotClock >= 10)] <- quadFGPer$mid[sqRow] / 100
  shotDB$expFGPer[which(shotDB$shotQuadrant == sq & shotDB$shotClock > 20)] <- quadFGPer$early[sqRow] / 100
}

#add expected points to each shot attempt
shotDB$expPts <- shotDB$FGtype * shotDB$expFGPer
shotDB$actPts <- shotDB$points - shotDB$expPts

#allBxD <- unique(paste0(shotDB$baseline,"_",shotDB$depth))
```

Table of Points Generated for a Team
```{r}
focalTeam <- "North Carolina"

subset(playerDB, team == focalTeam)

for (focalPlayer in subset(playerDB, team == focalTeam)$playerID) {
  focalName <- subset(playerDB, playerID == focalPlayer)$playerName
  #number of shots
  nShots  <- dim(subset(shotDB, playerID == focalPlayer))[1]
  #points v exp
  ptsOverExp <- sum(subset(shotDB, playerID == focalPlayer)$actPts)
  
  print(paste0(focalName," | ",nShots," shots | ",
               round(ptsOverExp, digits = 1)," pts | ",
               round(ptsOverExp/nShots, digits = 2)," per shot"))
}

```

Top Point Generated in NCAA
```{r}

tsPlayer <- vector()
tsTeam <- vector()
tsnShots <- vector()
tsnGames <- vector()
tsspg <- vector()
tsptsAdded <- vector()
tsptsPerShot <-  vector()

shotMin <- 30
ptsPerShot <- .1

playerList <- names(table(shotDB$playerID)[table(shotDB$playerID) >= shotMin])

focalPlayer <- playerList[14]

for (focalPlayer in playerList) {
  focalName <- subset(playerDB, playerID == focalPlayer)$playerName
  playerTeam <- subset(playerDB, playerID == focalPlayer)$team[1]
  #number of games
  nGames <- length(unique(subset(shotDB, playerID == focalPlayer)$gameNum))
  #number of shots
  nShots  <- dim(subset(shotDB, playerID == focalPlayer))[1]
  #points v exp
  ptsOverExp <- sum(subset(shotDB, playerID == focalPlayer)$actPts)
  
  if ( ptsOverExp / nShots > ptsPerShot & nShots / nGames >= 10 ) {
    tsPlayer <- c(tsPlayer,focalName)
    tsTeam <- c(tsTeam,playerTeam)
    tsnShots <- c(tsnShots,nShots)
    tsnGames <- c(tsnGames,nGames)
    tsspg <- c(tsspg,nShots / nGames)
    tsptsAdded <- c(tsptsAdded,ptsOverExp)
    tsptsPerShot <- c(tsptsPerShot,ptsOverExp / nShots)

    print(paste0(focalName," | ",playerTeam," | ",
                 nShots," shots, ",round(nShots/nGames, digits = 1)," per game | ",
                 round(ptsOverExp, digits = 1)," pts | +",
                 round(ptsOverExp/nShots, digits = 2)," per shot"))
  }
}

topScorers <- cbind.data.frame(tsPlayer,tsTeam,tsnShots,tsnGames,tsspg,tsptsAdded,tsptsPerShot)
colnames(topScorers) <- c("Player","Team","Shots","Games","Shots/Game","Pts Added","Pts/Shot")

topScorers <- topScorers[order(topScorers$`Pts/Shot`, decreasing = T),]

#sort and show top-10
topScorers <- head(topScorers, n = 10)
topScorers$`Shots/Game` <- round(topScorers$`Shots/Game`, digits = 1)
topScorers$`Pts Added` <- round(topScorers$`Pts Added`, digits = 1)
topScorers$`Pts/Shot` <- round(topScorers$`Pts/Shot`, digits = 3)

### make a table
gt_tbl <- gt(topScorers[,!colnames(topScorers) %in% "Shots"])

gt_tbl <-
  gt_tbl %>%
    tab_header(
      title = md("**Top Ten: Points Added Per Shot**"),
      subtitle = paste0("Min Shots Charted = ",shotMin,"   |   Points Added Over NCAA Average")
      )

gt_tbl <- 
  gt_tbl %>%
  tab_source_note(
    source_note = md(paste0("_Average value calc. from location and shot clock status of ",dim(shotDB)[1]," shots in the 2022-23 season_"))
  )

# Show the gt Table
gt_tbl <- 
  gt_tbl %>%
  data_color(
    columns = `Pts/Shot`,
    colors = scales::col_numeric(
      palette = c("white", "#C5050C"),
      domain = c(0, 1)
    )
  )

gt_tbl <- 
  gt_tbl %>%
  data_color(
    columns = `Shots/Game`,
    colors = scales::col_numeric(
      palette = c("white", "#4B9CD3"),
      domain = c(10, 15)
    )
  )

gt_tbl <- 
  gt_tbl %>%
  cols_align(
    align = "center",
    columns = c(Games,`Shots/Game`,`Pts Added`,`Pts/Shot`)
  )

gt_tbl <- 
  gt_tbl %>%
  tab_options(heading.title.font.size = 30, column_labels.font.weight = 'bold')


gt_tbl %>% gtsave(paste0(figDir,"TopTen_PtsPerShot_min",shotMin,"shots.html"))


```


defensive impact
```{r}
p <- 1405037

for (p in c(1243722,1243718,1133861,1138380,1185948,1405037)) {
  #shots against Seth
  sethIn <- shotDB$h1 == p | shotDB$h2 == p | shotDB$h3 == p | shotDB$h4 == p | shotDB$h5 == p
  
  sethShots <- shotDB[sethIn,]
  nsethShots <- shotDB[!sethIn,]
  
  nsethShots <- nsethShots[which(nsethShots$oppAbbv == "UNC"),]
  sethShots <- sethShots[which(sethShots$oppAbbv == "UNC"),]
  
  #1 - mean(nsethShots$outcome == "miss")
  #1 - mean(sethShots$outcome == "miss")
  
  #only 2s
  nseth2Shots <- subset(nsethShots, three == 0)
  seth2Shots <- subset(sethShots, three == 0)
  
  print(subset(playerDB, playerID == p)$playerName)
  print((1 - mean(nseth2Shots$outcome == "miss")) - (1 - mean(seth2Shots$outcome == "miss")))
  print(dim(nseth2Shots)[1])
  print(1 - mean(nseth2Shots$outcome == "miss"))
  print(dim(seth2Shots)[1])
  print(1 - mean(seth2Shots$outcome == "miss"))
}

ggplot(data = sethShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)

ggplot(data = nsethShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75, size = 3.25)

mean(subset(nsethShots, shotQuadrant == "AtRim")$outcome == "make")
mean(subset(sethShots, shotQuadrant == "AtRim")$outcome == "make")

mean(subset(nsethShots, shotQuadrant != "AtRim")$outcome == "make")
mean(subset(sethShots, shotQuadrant != "AtRim")$outcome == "make")

```



```{r UNC stuff}

focalPlayer <- 1243718

plotShots <- subset(shotDB, playerID == 1243718)

ggplot(data = plotShots,
       aes(x = baseline,
           y = depth,
           col = outcome)) +
  geom_point(alpha = .75,size = 3) + 
  xlim(c(0,50)) + ylim(c(0,40))

sum(subset(shotDB, playerID == focalPlayer & FGtype == 2)$actPts) / dim(subset(shotDB, playerID == focalPlayer & FGtype == 2))[1]
sum(subset(shotDB, playerID == focalPlayer & FGtype == 2)$actPts)
sum(subset(shotDB, playerID == focalPlayer & FGtype == 3)$actPts) / dim(subset(shotDB, playerID == focalPlayer & FGtype == 3))[1]
sum(subset(shotDB, playerID == focalPlayer & FGtype == 3)$actPts)

focalPlayer <- 1243718
plotShots <- subset(shotDB, playerID == focalPlayer)

ggplot(data = plotShots,
       aes(x = baseline,
           y = depth,
           col = outcome, 
           shape = as.character(FGtype))) +
  geom_point(alpha = .75,size = 3) + 
  xlim(c(0,50)) + ylim(c(0,40))
```

